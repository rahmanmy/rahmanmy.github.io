<!DOCTYPE html>
<html>
    <script type="text/javascript" src="/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="/js/search.js"></script>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="阿卜">
  <!-- Open Graph Data -->
  <meta property="og:title" content="实例教程 - 在线账本 (二)"/>
  <meta property="og:description" content="阿卜个人博客" />
  <meta property="og:site_name" content="Rahman&#39;s Blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://rahmanmy.github.io"/>
  
    <link rel="alternate" href="/atom.xml" title="Rahman&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Rahman's Blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-139890203-1', 'auto');
        ga('send', 'pageview');
    </script>


</head>

  <body>
    <!-- 单篇文章内容页面 -->
<!-- Page Header -->

<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">实例教程 - 在线账本 (二)</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="/categories">
                  
                  Categories
                  
                </a>
              </li>
            
              <li>
                <a href="/tags">
                  
                  Tags
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/rahmanmy">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:932696181@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div id="article-content" class="col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By 阿卜</span>
          
          <!-- Date -->
          <span class="date-time info">
            On <span class="date">2019/05/14</span>
            <span class="time">23:27:52</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Category <!-- 文章内容页面中的 Categories 部分 -->

<a href="/categories/实例教程/">实例教程</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: <!-- 文章内容页中的 Tags 部分 -->


<a class="tag" href="/tags/Java/">#Java</a> <a class="tag" href="/tags/Web/">#Web</a> <a class="tag" href="/tags/jQuery/">#jQuery</a> <a class="tag" href="/tags/Web-lighter/">#Web-lighter</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>本教程出自于<a href="https://baileykm.github.io" target="_blank" rel="noopener">白师傅</a>、<br>此为系列教程的第二部分: <em>客户端 (前端) + 服务器端 (后端) 模式的在线记账本</em>. </p>
<p>本节我们将在上节的基础上进一步完成服务器端的开发, 从而将我们的记账本变为前、后端贯通的 B/S 软件.</p>
<a id="more"></a>
<div class="toc">

<!-- toc -->
<ul>
<li><a href="#6-da-jian-fu-wu-qi-duan-huan-jing">6. 搭建服务器端环境</a><ul>
<li><a href="#6-1-an-zhuang-jdk">6.1 安装 JDK</a></li>
<li><a href="#6-2-an-zhuang-yu-pei-zhi-tomcat">6.2 安装与配置 Tomcat</a></li>
</ul>
</li>
<li><a href="#7-chuang-jian-dong-tai-web-xiang-mu">7. 创建动态 Web 项目</a></li>
<li><a href="#8-jian-li-fu-wu-qi-duan-zhang-dan-de-shu-ju-mo-xing">8. 建立服务器端账单的数据模型</a></li>
<li><a href="#9-shi-xian-zhang-ben-fu-wu">9. 实现账本服务</a></li>
<li><a href="#10-jian-ting-bing-fen-fa-qian-duan-qing-qiu">10. 监听并分发前端请求</a></li>
<li><a href="#11-dui-jie-fu-wu-qi-duan">11. 对接服务器端</a><ul>
<li><a href="#11-1-cong-fu-wu-qi-duan-huo-qu-zhang-ben-shu-ju">11.1 从服务器端获取账本数据</a></li>
<li><a href="#11-2-jiang-xin-zeng-zhang-dan-bao-cun-dao-fu-wu-qi-duan">11.2 将新增账单保存到服务器端</a></li>
<li><a href="#11-3-yu-fu-wu-qi-duan-tong-bu-shan-chu-zhang-dan">11.3 与服务器端同步删除账单</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
</div>

<h1><a href="#6-da-jian-fu-wu-qi-duan-huan-jing" class="header-anchor"></a><span id="6-da-jian-fu-wu-qi-duan-huan-jing">6. 搭建服务器端环境</span></h1><p>有很多种技术可以用来实现网站的服务器端, 比如: PHP, ASP, ASP.NET, J2EE ….</p>
<p>这里我们选用 J2EE 技术, 可以把这样的网站称作 Java Web 应用程序. </p>
<p>既然是 Java Web 应用程序, 自然 JDK 的安装是少不了的, 请自行下载并安装 JDK.</p>
<p>此外, 还需要安装一个 Java Web 容器, 我们的网站将运行在 Web 容器的世界里. 同样, Java Web 容器也有很多, 比如: Tomcat, WebLogic, WebSphere, JBOSS….</p>
<p>当然, 你还得安装一个称手的集成开发环境 (IDE), 比如: Eclipse, ItelliJ IDEA ….</p>
<blockquote>
<p>本教程示例代码基于 JDK1.8 + Tomcat 8.5 测试通过</p>
<p>本教程使用的 IDE 是 ItelliJ IDEA</p>
</blockquote>
<p>准备就绪, 我们就开始吧 ~</p>
<h2><a href="#6-1-an-zhuang-jdk" class="header-anchor"></a><span id="6-1-an-zhuang-jdk">6.1 安装 JDK</span></h2><p>这个没什么好说的, Windows 下的 JDK 安装无非就是双击运行安装程序, 一路 “Next”, 直至 “Finish”. </p>
<p>只是安装过程中请关注一下你的 JDK 的安装路径, 待会需要用到.</p>
<h2><a href="#6-2-an-zhuang-yu-pei-zhi-tomcat" class="header-anchor"></a><span id="6-2-an-zhuang-yu-pei-zhi-tomcat">6.2 安装与配置 Tomcat</span></h2><p>建议使用解压版的 Tomcat. 找一个你中意的位置解压 Tomcat 压缩文件, 在<strong>系统变量</strong>中添加 JAVA_HOME, 值为 JDK 安装路径.</p>
<p>在<strong>控制台</strong>下进入 Tomcat 解压目录中的 bin 目录, 运行 startup.bat, 等待 Tomcat 启动完成.</p>
<p>打开浏览器, 地址栏输入 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>, 回车. 如果一切顺利, 你应该可以看到类似这样的页面:</p>
<p><img src="/images/20190514-4.png" alt="Tomcat主页"></p>
<p>看到上图的页面, Happy 一下之后即可关闭控制台窗口. </p>
<blockquote>
<p>记得关闭, 否则在下一步可能导致你创建的动态 Web 项目不能正常启动</p>
</blockquote>
<blockquote>
<p>当然, 如果你是个勤奋的孩子, 可能你的电脑上还安装了诸如 php 环境之类的东东, 那它们可能会抢先一步占领 Tomcat 默认使用的 8080 端口, 此时可以打开 Tomcat <em>conf</em> 文件夹下的 <em>server.xml</em> 更改其中的端口配置.</p>
</blockquote>
<blockquote>
<p>关于 JDK, Tomcat 及 开发环境的安装配置真懒得说太多, 打开百度可以搜索到 N 个教程. 如果有问题就问度娘吧~</p>
</blockquote>
<h1><a href="#7-chuang-jian-dong-tai-web-xiang-mu" class="header-anchor"></a><span id="7-chuang-jian-dong-tai-web-xiang-mu">7. 创建动态 Web 项目</span></h1><p>在 IDEA 中, 选择 File &gt; New &gt; Project… 菜单, 在弹出的 “New Project” 窗口中选择 Java Enterprise &gt; Web Application</p>
<p><img src="/images/20190514-5.png" alt="IDEA 新建 Web 项目"></p>
<p> 注意上图红框中的内容, 如果是空的, 选一下 或者 “New…” 一下.</p>
<p>然后, “Next”, 填写一个项目名称, “Finish”. 这样一个动态 Web 项目就创建好了.</p>
<blockquote>
<p>如果你知道怎么使用 Maven, 强烈建议将此项目建为 Maven web-app</p>
<p>强烈建议自学 Maven ! 关于 Maven 可以看看 <a href="https://www.cnblogs.com/libingbin/p/6104588.html" target="_blank" rel="noopener">这篇文章</a></p>
</blockquote>
<p>接着, 把前一节 ( 在线账本(一) ) 写的代码以及第三方文件依次拷贝到当前新建的项目中, 完成后大概是下图这个结构:</p>
<p><img src="/images/20190514-8.png" alt="IDEA 新建 Web 项目"></p>
<blockquote>
<p>如果你是使用 Eclipse 创建的动态 Web 项目, 可能上图中的 web 文件夹名为 webContent</p>
<p>上图中有些文件若没有, 可从上节下载的压缩文件中拷贝(index.js 除外, 这个文件要你自己写).</p>
</blockquote>
<p>在 IDEA 主界面右上角的选择 Edit Configurations, 如<em>图-7.1</em>:</p>
<p><strong>图-7.1</strong></p>
<p><img src="/images/20190514-6.png" alt="Edit Configurations"></p>
<p>在出现的 Run/Debug Configurations 窗口中注意关注一下图红框的内容, 这个 URL 将是你网站的根.</p>
<p><strong>图-7.2</strong></p>
<p><img src="/images/20190514-7.png" alt="Configurations"></p>
<p>关闭<em>图-7.2</em>窗口, 点击<em>图-7.1</em>中那个绿色的 “虫” (Debug…), 以调试模式启动项目.</p>
<p>项目启动完成后, 打开浏览器, 地址栏输入 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>, 回车. 你应该可以看到上一节完成的那个记账本的页面.</p>
<blockquote>
<p>若图-7.2 中红框内容不是 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>, 则地址栏输入的 URL 相应改变一下.</p>
</blockquote>
<p>​    </p>
<p>到此为止, 我们把此前做的 “纯前端的记账本” 移置到了动态 Web 项目里了.</p>
<p>记住, 从现在开始记账本页面的正确打开方式应是 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a> , 而<strong>不是</strong>直接双击 index.html !</p>
<h1><a href="#8-jian-li-fu-wu-qi-duan-zhang-dan-de-shu-ju-mo-xing" class="header-anchor"></a><span id="8-jian-li-fu-wu-qi-duan-zhang-dan-de-shu-ju-mo-xing">8. 建立服务器端账单的数据模型</span></h1><p>又来啦~ 数据模型~ MVC ~ </p>
<p>YES, 让我们仍然从数据模型开始…</p>
<p>在项目的 <code>src</code> 目录下创建 <code>example.vo</code> 包 (package), 并在此包中创建一个类: <code>Bill</code></p>
<p>目录结构大概如下:</p>
<p><img src="/images/20190514-9.png" alt="目录结构"></p>
<blockquote>
<p>图中 example 下的其余包 (文件夹) 可以一并创建, 以后会用到</p>
</blockquote>
<p><strong>Code-8.1: Bill.java</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.vo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一条账单的数据模型 (VO类)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bill</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;            <span class="comment">// 账单ID</span></span><br><span class="line">    <span class="keyword">private</span> Date time;             <span class="comment">// 账单时间</span></span><br><span class="line">    <span class="keyword">private</span> Long amount;           <span class="comment">// 金额</span></span><br><span class="line">    <span class="keyword">private</span> String memo;           <span class="comment">// 备注</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTime</span><span class="params">(Date time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(Long amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMemo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> memo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMemo</span><span class="params">(String memo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.memo = memo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看出来了吗? 这个类的结构和<strong>前端</strong>账单数据数据结构是一致的.</p>
<p>在服务器我们就要使用这个Bill 类的实例 (对象) 来存储一条账单的信息.</p>
<h1><a href="#9-shi-xian-zhang-ben-fu-wu" class="header-anchor"></a><span id="9-shi-xian-zhang-ben-fu-wu">9. 实现账本服务</span></h1><p>这个标题好诡异… 什么叫账本服务? 姑且这样吧, 我也不知道取什么标题好.</p>
<p>在这里, 我们在<code>example.service</code>包下创建一个账本服务类<code>AccountBookService</code>, 以提供账本数据存储, 新增账单, 删除账单等服务. </p>
<p>代码如下:</p>
<p><strong>Code-9.1: AccountBookService.java</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> example.vo.Bill;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 账本服务类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountBookService</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 账本服务单例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AccountBookService instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 账本中的账单列表</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Bill&gt; bills;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 账本服务构造函数, 注意 private 修饰符, 为的是将此服务实现为"单例"</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AccountBookService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建 AccountBookService 实例时构建一些测试用的数据</span></span><br><span class="line">        buildTestData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 静态(static) 的 getInstance() 方法返回账本服务单例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AccountBookService <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> AccountBookService();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回账本中的账单列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Bill&gt; <span class="title">getBills</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bills;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加 1 条账单</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBillItem</span><span class="params">(Bill bill)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将新账单插入到最前面</span></span><br><span class="line">        bills.add(<span class="number">0</span>, bill);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除 1 条账单</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBillItem</span><span class="params">(Bill billToRemove)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;Bill&gt; itr = bills.iterator(); itr.hasNext(); ) &#123;</span><br><span class="line">            Bill bill = itr.next();</span><br><span class="line">            <span class="keyword">if</span> (bill.getId().equals(billToRemove.getId())) &#123;</span><br><span class="line">                itr.remove();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构建一个 5 行账单记录的账本. 测试用</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildTestData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        bills = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            Bill bill = <span class="keyword">new</span> Bill();</span><br><span class="line">            bill.setId(i);</span><br><span class="line">            bill.setTime(<span class="keyword">new</span> Date());</span><br><span class="line">            bill.setAmount(Math.round(Math.random() * <span class="number">10000</span>));</span><br><span class="line">            bill.setMemo(<span class="string">"收入"</span> + bill.getAmount() / <span class="number">100.0</span> + <span class="string">"元"</span>);</span><br><span class="line">            bills.add(bill);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解释一下:</p>
<ul>
<li><p>上面代码的注释中多次提到”单例”这个词, 它来自<strong>设计模式</strong>中的<strong>单例模式</strong>这个概念. 简单说, 所谓单例, 就是我们希望在当前的运行环境中, 某个类的实例(对象)只有一个(唯一的). </p>
<p>显然, 在这里, 我们希望账本服务 (AccountBookService) 只有一个实例, 否则多个服务提供账本, 那这个世界不就乱了吗? </p>
<blockquote>
<ul>
<li><p>关于单例模式的实现, 可参考上述代码第 14 行 及 19 ~ 31 行</p>
</li>
<li><p>建议抽空自学 “设计模式”</p>
</li>
</ul>
</blockquote>
</li>
<li><p>第 17 行使用一个 <code>List&lt;Bill&gt;</code> 来存储账本 (多条账单) 数据, 其中的每一个元素即为一条账单 (Bill 对象, 参见 Code-8.1). </p>
</li>
<li><p>第 39 ~ 42 行, 45 ~ 53 行分别实现了新增 1 条账单和删除 1 条账单的逻辑. </p>
<p>这些代码的功能和逻辑与第 (一) 节中新增/删除账单的代码类似, 只是这里使用 Java 语言描述. (参见第 (一) 节, Code-4.2.2, Code-5.2.1)</p>
</li>
</ul>
<ul>
<li>第 57 ~ 67 行的 <code>buildTestData()</code>方法构建了一个 5 行账单记录的账本, 用于测试.</li>
</ul>
<h1><a href="#10-jian-ting-bing-fen-fa-qian-duan-qing-qiu" class="header-anchor"></a><span id="10-jian-ting-bing-fen-fa-qian-duan-qing-qiu">10. 监听并分发前端请求</span></h1><p>看完前面第 8, 9 节是不是一头雾水, 到底要干什么呀, 到底要怎么把前后端对接起来呀~ </p>
<p>别急, 现在就开始…</p>
<p>大致的思路是: 在服务器使用一个 Servlet 监听前端发来的请求, 在服务器端做相应的处理, 最后将处理结果反馈给前端.</p>
<p>本文为了简便, 我们来使用本人封装的小工具: <em>Web-lighter</em>,  关于这个东东的详细介绍, 请参看 <a href="/2018/06/01/Web-lighter-一个小型的-Java-Web-服务器端封装/">Web-lighter 简介</a></p>
<blockquote>
<p>安利一下! 用上 web-lighter, 真香!</p>
<p>web-lighter 的底层也是使用的 servlet. </p>
<p>现在先别忙着跑去看 web-lighter 说明书, 继续跟着来, 说不定学完本节你也就会了.</p>
</blockquote>
<p>在项目的<code>WEB-INF</code>文件夹下创建一个名为 <code>lib</code> 的文件夹, 将 <a href="/attachment/web-lighter-libs.zip">web-lighter 及其依赖的第三方 jar 文件</a> 拷贝到此文件夹. 如图:</p>
<p><img src="/images/20190514-10.png" alt="web-lighter及依赖文件"></p>
<p>选中所有新拷入的 jar 文件, 右键菜单中选择 <em>Add As Library…</em> , 将这些 jar 文件添加到构建路径. </p>
<blockquote>
<ul>
<li>以上操作的目的在于将 web-lighter 及其依赖的第三方 jar 放入项目构建路径(Build Path). 若使用其它 IDE, 操作方法与上文所述有一定差异, 但目的一致.</li>
<li>如果你使用 Maven 则只需配置 pom.xml, 将 web-lighter 加入项目依赖. 具体方法参看 <a href="/2018/06/01/Web-lighter-一个小型的-Java-Web-服务器端封装/">Web-lighter 简介</a>    </li>
</ul>
</blockquote>
<p>准备就绪, 开始写程序啦~</p>
<p>在<code>example.actoin</code>包下创建<code>BillAction</code>类, 用于监听前端发来的请求, 进行处理后, 将结果反馈给前端.</p>
<p><strong>Code-10.1:  BillAction.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> example.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.action.ActionResult;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.action.ActionSupport;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Inject;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Param;</span><br><span class="line"><span class="keyword">import</span> com.bailey.web.lighter.annotation.Request;</span><br><span class="line"><span class="keyword">import</span> example.service.AccountBookService;</span><br><span class="line"><span class="keyword">import</span> example.vo.Bill;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理前端关于账单的请求的 Action 类</span></span><br><span class="line"><span class="comment">// 注意继承 com.bailey.web.lighter.action.ActionSupport</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BillAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应前端 /wl/getBills 请求, 将账本中的所有账单记录返回前端.</span></span><br><span class="line">    <span class="comment">// 注意形参表中使用 @Inject 注解, 以告知 Web-lighter 将 AccountBookService 实例作为参数注入</span></span><br><span class="line">    <span class="meta">@Request</span>(url = <span class="string">"/getBills"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">getBills</span><span class="params">(@Inject AccountBookService service)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// service.getBills() 将获得账本中的所有账单数据 ( List&lt;Bill&gt; )</span></span><br><span class="line">        <span class="comment">// 参见 Code-9.1 中 34 行</span></span><br><span class="line">        <span class="keyword">return</span> ActionResult.success(service.getBills());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应前端 /wl/saveOrUpdateBill 请求, 实现保存/更新账单功能</span></span><br><span class="line">    <span class="comment">// @Inject 注解告知 Web-lighter 将 AccountBookService 实例作为参数注入</span></span><br><span class="line">    <span class="comment">// @Param  注解告知 Web-lighter 将前端上行的 action, bill 两个参数分别解析后注入</span></span><br><span class="line">    <span class="meta">@Request</span>(url = <span class="string">"/saveOrUpdateBill"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionResult <span class="title">saveOrUpdateBill</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @Inject AccountBookService service,</span></span></span><br><span class="line"><span class="function"><span class="params">            @Param(name = <span class="string">"action"</span>)</span> String action,</span></span><br><span class="line"><span class="function">            @<span class="title">Param</span><span class="params">(name = <span class="string">"bill"</span>)</span> Bill bill) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据上行参数 action 确定前端请求是要新增账单, 还是删除账单</span></span><br><span class="line">        <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"append"</span>:</span><br><span class="line">                <span class="comment">// 调用 AccountBookService 中的 addBillItem() 方法将新账单数据添入账本</span></span><br><span class="line">                <span class="comment">// 参见 Code-9.1 中第 39 行</span></span><br><span class="line">                service.addBillItem(bill);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"remove"</span>:</span><br><span class="line">                <span class="comment">// 调用 AccountBookService 中的 removeBillItem() 方法将账单从账本中删除</span></span><br><span class="line">                <span class="comment">// 参见 Code-9.1 中第 45 行</span></span><br><span class="line">                service.removeBillItem(bill);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// 返回保存后的账单信息</span></span><br><span class="line">        <span class="keyword">return</span> ActionResult.success(bill);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中注释都已经写满了, 就不对具体的代码作更多解释了.</p>
<p>​    </p>
<p><strong>小结:</strong></p>
<ul>
<li><code>BillAction</code>负责监听前端各种请求, 然后转发给<code>AccountBookService</code>的具体方法来处理.</li>
<li><code>AccountBookService</code>负责管理账本数据, 并提供了 <em>添加/删除</em> 账单功能. </li>
<li><code>Bill</code> 用于封装一条账单的数据.</li>
</ul>
<p>为保万无一失, 来对比一下我们的 src 文件夹结构是否如下图:</p>
<p><img src="/images/20190514-12.png" alt="src目录结构"></p>
<p>​    </p>
<p>好了, 现在服务器端的事情已经干完了, <strong>重启 Tomcat</strong>, 等待前端发来请求吧~</p>
<p>当然我们还得修改前端代码, 以使其能正确地和服务器端对接.</p>
<h1><a href="#11-dui-jie-fu-wu-qi-duan" class="header-anchor"></a><span id="11-dui-jie-fu-wu-qi-duan">11. 对接服务器端</span></h1><p>盼星星, 盼月亮, 终于等到了这一天~ </p>
<p>来吧, 以下修改的是前端 <strong>index.js</strong> 中的内容.</p>
<h2><a href="#11-1-cong-fu-wu-qi-duan-huo-qu-zhang-ben-shu-ju" class="header-anchor"></a><span id="11-1-cong-fu-wu-qi-duan-huo-qu-zhang-ben-shu-ju">11.1  从服务器端获取账本数据</span></h2><p>首先我们在 index.js 中添加一个函数, 来完成向服务器端请求账本数据, 对接 Code-10.1 中第 17 ~ 22 行</p>
<p><strong>Code-11.1.1</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从服务器端获得账本数据</span></span><br><span class="line"><span class="comment">// 注意参数 callback 函数为从服务器端成功取到数据后的回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getBillsFromServer</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 使用 jQuery 向服务器端发送 Ajax 请求</span></span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">"/wl/getBills"</span>,          <span class="comment">// 对应 Code-10.1 第 17 行, 注意多了 "/wl" 前缀</span></span><br><span class="line">        type: <span class="string">'post'</span>,                 <span class="comment">// 声明以 Post 方式发送请求</span></span><br><span class="line">        dataType: <span class="string">"json"</span>,             <span class="comment">// 告诉 jQuery, 服务器端返回的数据是 JSON 格式</span></span><br><span class="line">        beforeSend: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;     <span class="comment">// 发送请求前的回调函数</span></span><br><span class="line">            $(<span class="string">"#progress"</span>).show();    <span class="comment">// 发送请求前显示进度提示(左下角一个绕圈圈的动画)</span></span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">resp</span>) </span>&#123;    <span class="comment">// 请求成功时的回调函数</span></span><br><span class="line">            <span class="keyword">if</span> (resp.code &gt;= <span class="number">0</span>) &#123;     <span class="comment">// 若服务器端回应数据中状态码 code &gt;= 0, 说明服务器端一切正常</span></span><br><span class="line">                callback(resp.result);<span class="comment">// 回调 callback 函数, 并将服务器端返回的数据传入</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;          <span class="comment">// 请求失败的回调函数</span></span><br><span class="line">            $.fail(<span class="string">"出错啦!"</span>)     </span><br><span class="line">        &#125;,</span><br><span class="line">        complete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;       <span class="comment">// 请求完成时的回调函数</span></span><br><span class="line">            $(<span class="string">"#progress"</span>).hide();    <span class="comment">// 隐藏进度提示</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改<code>$(document).ready(function () {...});</code>代码, 变成在初始时从服务器端获取账本数据, 而不再使用前端 bills 数组的账单数据. 修改后的代码如下 (注意和 Code-4.2.1进行对比):</p>
<p><strong>Code-11.1.2</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 从服务器端获取账本数据</span></span><br><span class="line">    <span class="comment">// 此处调用的是 Code-11.1.1 中定义的那个 getBillsFromServer 函数</span></span><br><span class="line">    <span class="comment">// 你找到 Code-11.1.1 中 getBillsFromServer 函数所需要的 callback 回调函数了吗?</span></span><br><span class="line">    getBillsFromServer(<span class="function"><span class="keyword">function</span> (<span class="params">result</span>) </span>&#123;		</span><br><span class="line">        <span class="comment">// 将获取到的数据赋值给 bills 数组</span></span><br><span class="line">        bills = result;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示账单列表</span></span><br><span class="line">        showBillItems();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 显示结余</span></span><br><span class="line">        refreshBalance();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册打开/关闭记账按钮的点击事件监听</span></span><br><span class="line">    $(<span class="string">'#btn-add-bill'</span>).click(toggleBillEditor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册 "记一笔" 按钮点击事件监听</span></span><br><span class="line">    $(<span class="string">'#btn-confirm-add'</span>).click(addBillItem);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>好了, 现在打开浏览器, 地址栏输入 <a href="http://localhost:8080" target="_blank" rel="noopener">http://localhost:8080</a>, 是否看到的账单数据变成了服务器端的数据了?</p>
<blockquote>
<p>怎么看出是从服务器端来的数据? 呵呵~  从服务器端来的账单时间都是当前系统时间. (看服务器端代码 Code-9.1 第 57 ~ 67 行就知道了)</p>
</blockquote>
<p><strong>注意:</strong> 因为我们使用了 web-lighter, 它自动把服务器端待回传数据 (bills) 使用 JSON 格式进行了打包 (Code-10.1 第 21 行). </p>
<p>打开浏览器调试界面 (如: Chrome 中的开发者工具), 可以看到从服务器端回传的数据, 如图:</p>
<p><img src="/images/20190514-13.png" alt="服务器回传数据"></p>
<blockquote>
<ul>
<li>若你未使用 web-lighter, 应注意对应地修改 Code-11.1.1 第 8 行的配置, 以及第 12 ~ 16 行和其它地方的代码逻辑. 总之, 前后端的数据格式要配套.</li>
<li>web-lighter 使用 JSON 格式对回传数据进行打包, 数据包中 code 为状态码, 默认情况下 code &lt; 0 表示出错, result 为数据部分. 参看 <a href="/2018/06/01/Web-lighter-一个小型的-Java-Web-服务器端封装/">Web-lighter 简介</a></li>
</ul>
</blockquote>
<h2><a href="#11-2-jiang-xin-zeng-zhang-dan-bao-cun-dao-fu-wu-qi-duan" class="header-anchor"></a><span id="11-2-jiang-xin-zeng-zhang-dan-bao-cun-dao-fu-wu-qi-duan">11.2  将新增账单保存到服务器端</span></h2><p>此前服务器端已经做好了保存账单数据的准备, 此时我们只需修改前端代码既可:</p>
<h4><a href="#11-2-1-dui-jie-fu-wu-qi-duan-saveorupdatebill" class="header-anchor"></a><span id="11-2-1-dui-jie-fu-wu-qi-duan-saveorupdatebill">11.2.1 对接服务器端 saveOrUpdateBill</span></h4><p><strong>Code-11.2.1</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存数据更改到服务端</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveToServer</span>(<span class="params">action, bill, callback</span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: <span class="string">"/wl/saveOrUpdateBill"</span>,      <span class="comment">// 对应服务器端 (Code-10.1 第 27 行), 注意前缀"/wl"</span></span><br><span class="line">        type: <span class="string">'post'</span>,</span><br><span class="line">        dataType: <span class="string">"json"</span>,</span><br><span class="line">        data: &#123;                           <span class="comment">// 上行参数</span></span><br><span class="line">            action: action,               <span class="comment">// 对应服务器端 Action 方法参数 (Code-10.1 第 30 行)</span></span><br><span class="line">            bill: <span class="built_in">JSON</span>.stringify(bill)    <span class="comment">// 对应服务器端 Action 方法参数 (Code-10.1 第 31 行)</span></span><br><span class="line">        &#125;,</span><br><span class="line">        beforeSend: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $(<span class="string">"#progress"</span>).show();</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">resp</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (resp.code &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                callback(resp.result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        error: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $.fail(<span class="string">"出错啦!"</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        complete: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            $(<span class="string">"#progress"</span>).hide();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意: Code-11.2.1 中第 9 行使用 <code>JSON.stringify(bill)</code> 将账单数据按 JSON 格式进行了序列化. 即: 将 bill 对象转为 JSON 格式字符串.</p>
<h4><a href="#11-2-2-wan-cheng-xin-zeng-zhang-dan-shu-ju-gong-neng" class="header-anchor"></a><span id="11-2-2-wan-cheng-xin-zeng-zhang-dan-shu-ju-gong-neng">11.2.2  完成新增账单数据功能</span></h4><p>修改 <strong>index.js</strong> 中的 <code>addBillItemData</code> 方法(Code-4.2.2), 以将数据保存到服务器端:</p>
<p><strong>Code-11.2.2</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 新增一条账单的数据到账本数据模型</span></span><br><span class="line"><span class="comment">// 参数说明:</span></span><br><span class="line"><span class="comment">// bill - 新账单的数据, 一个对象, 形如 Code-3.3.1 中展示的那样一坨</span></span><br><span class="line"><span class="comment">// callback - 数据模型更新成功后的回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addBillItemData</span>(<span class="params">bill, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 保存数据到服务器端</span></span><br><span class="line">    saveToServer(<span class="string">'append'</span>, bill, <span class="function"><span class="keyword">function</span> (<span class="params">newBill</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 更新前端账本数据, 以保持和服务器端一致</span></span><br><span class="line">        bills.unshift(newBill);</span><br><span class="line">        <span class="comment">// 回调刷新界面</span></span><br><span class="line">        callback(newBill);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    </p>
<p>OK, 现在刷新一下浏览器, 试一下, 新增账单时数据是不是已经保存到服务器端了.</p>
<blockquote>
<p>怎么看出来数据已经保存到服务器端?</p>
<p>呵呵, 若数据保存在服务器端, 新增账单后, 刷新浏览器, 新账单数据并不会丢失.</p>
</blockquote>
<p>​    </p>
<h2><a href="#11-3-yu-fu-wu-qi-duan-tong-bu-shan-chu-zhang-dan" class="header-anchor"></a><span id="11-3-yu-fu-wu-qi-duan-tong-bu-shan-chu-zhang-dan">11.3   与服务器端同步删除账单</span></h2><p>修改 <code>index.js</code> 中的 <code>removeBillData()</code>函数:</p>
<p><strong>Code-11.3.1</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除一条账单的数据</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeBillData</span>(<span class="params">bill, callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 保存数据到服务器端, 调用的仍然是 Code-11.2.1 中的 saveToServer 函数, 只是参数变了</span></span><br><span class="line">    saveToServer(<span class="string">'remove'</span>, bill, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; </span><br><span class="line">        <span class="comment">// 删除前端账本数据模型中对应的记录, 与服务器端保存一致</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bills.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bills[i].id === bill.id) &#123;</span><br><span class="line">                bills.splice(i, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 回调刷新界面</span></span><br><span class="line">        callback();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 注意和原先 index.js 中的 removeBillData() 函数 (Code-5.2.1) 对比一下:</p>
<p>上一节中我们只是从前端账本 (bills) 中移除了待删除账单 (bill), 而在这里, 我们先通知服务器端删除账单数据, 成功后再移除前端账本中的数据, 以保持前后端同步.</p>
<p>​    </p>
<hr>
<p>好了, 就这样, 我们实现了基于客户端 + 服务器模式的在线记账本.</p>
<p>现在, 只要不重启服务器端的 Tomcat 无论如何刷新页面(即使关闭浏览器重新开启), 你的账单数据都不会丢失.</p>
<p>我们来做一下小结:</p>
<ul>
<li>客户端 + 服务器模式的在线记账本的工作流程: <ol>
<li>浏览器中打开 index.html 页面时, 客户端自动向服务器发起 Ajax 请求 ( getBillsFromServer() ), 取得账本数据, 呈现初始账单列表</li>
<li>当客户端有动作时(添加/删除账单), 向服务器端发送 Ajax 请求 ( saveToServer() ), 通知服务器端</li>
<li>服务器端更新账本数据模型, 成功后反馈更新结果</li>
<li>刷新前端页面</li>
<li>后续的用户操作, 继续重复上述  2 ~ 4 步</li>
</ol>
</li>
</ul>
<ul>
<li><p>本节使用了 web-lighter, 它只是一个服务器端的轻量级封装, 为的是简化开发过程. </p>
<p>当领悟了整个开发过程后, 建议尝试一下使用原生的 Servlet 来完成 BillAction 的功能, 为的是更加清楚底层的原理. 当然, 也可以使用 Struts 等其它第三方框架来实现.</p>
</li>
<li><p>服务器端同样有一个 MVC 模型, 相对而言服务器端的账本数据 (bills) 是它的 Model 层, 而 BillAction 属于服务器端的  Controller 层, 其返回的  ActionResult 更像服务器端的 View. </p>
<p>服务器端的 View 层通过网络通信和客户端的 Model 层对接, 从而形成一个 MVC 链, 上游的 View 层与下游的 Model 层对接.</p>
</li>
<li><p>按照 MVC 模式的低耦合架构, 使得我们即便在前一节的基础上加入了服务器端, 前端代码相较于前一节也没有太大的改动. </p>
<p>其实前端代码主要变动的只是与前端的 Model 层相关的部分: 构建数据模型 ( getBillsFromServer() ) 和更新数据模型 ( addBillItemData(), removeBillData()  )的那部分.</p>
</li>
</ul>
<blockquote>
<p>后两点是不是有点看不明白呀~ 细细揣摩一下…</p>
</blockquote>
<p>​    </p>
<p>下一节我们将使用数据库来存储账本数据, 这样就实现了真正意义上的在线记账本. 即使服务器端重启 Tomcat, 你的账本仍然不会丢失.</p>
<p>准备好了, 就继续看下一节吧…</p>

        </div>
        <p class="post-revise-info">
            Revised on <span class="date">2019/08/16 14:11:49</span> by 阿卜
        </p>
        
        <!-- 上一篇/下一篇  -->
        <hr/>
        <ul class="post-paginator">
            <li class="next">
                
                    <div class="nextSlogan">Next Post</div>
                    <a href= "/2019/05/14/实例教程-在线账本-3/" title= "实例教程 - 在线账本 (三)">
                        实例教程 - 在线账本 (三)
                    </a>
                
            </li>
            <li class="previous">
                
                    <div class="prevSlogan">Previous Post</div>
                    <a href= "/2019/05/14/实例教程-在线账本-1/" title= "实例教程 - 在线账本 (一)">
                        实例教程 - 在线账本 (一)
                    </a>
                
            </li>
        </ul>
      </div>
    </div>
  </div>
</article>

<script>
  var toc = document.querySelector(".toc");
  // 若有侧边目录, 则设置目录效果
  if (toc) {
    toc.onmouseover = function(){
      toc.classList.remove("toc-shrink");
    };
    toc.onmouseout = function(){
      toc.classList.add("toc-shrink");
    };

    // 延迟 5 秒后自动隐藏
    window.setTimeout(function(){
      toc.classList.add("toc-shrink");
    }, 5000);

    // 目录跟随滚动效果
    var setTocPosition = function() {
      //变量t是滚动条滚动时，距离顶部的距离
      var t = document.documentElement.scrollTop||document.body.scrollTop;
    
      //当滚动到距离顶部200px时，返回顶部的锚点显示
      if(t < 300){
        toc.style.top = (300 - t) + 'px';
      } else{          //恢复正常
        toc.style.top = "20px";
      }
    }

    window.onscroll = function(){
        setTocPosition();
    }
    setTocPosition();
  }
</script>


    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a> 
        <p class="copyright text-muted">
          Copyright By <a href="mailto:baileiz@163.com">阿卜.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<!-- <script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script> -->

  </body>
</html>

