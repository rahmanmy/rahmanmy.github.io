<!DOCTYPE html>
<html>
    <script type="text/javascript" src="/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="/js/search.js"></script>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="阿卜">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Cayenne 起步 (Version 3.1) [译]"/>
  <meta property="og:description" content="阿卜个人博客" />
  <meta property="og:site_name" content="Rahman&#39;s Blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://rahmanmy.github.io"/>
  
    <link rel="alternate" href="/atom.xml" title="Rahman&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Rahman's Blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-139890203-1', 'auto');
        ga('send', 'pageview');
    </script>


</head>

  <body>
    <!-- 单篇文章内容页面 -->
<!-- Page Header -->

<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Cayenne 起步 (Version 3.1) [译]</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="/categories">
                  
                  Categories
                  
                </a>
              </li>
            
              <li>
                <a href="/tags">
                  
                  Tags
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/rahmanmy">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:932696181@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div id="article-content" class="col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By 阿卜</span>
          
          <!-- Date -->
          <span class="date-time info">
            On <span class="date">2018/04/21</span>
            <span class="time">01:37:12</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Category <!-- 文章内容页面中的 Categories 部分 -->

<a href="/categories/入门教程/">入门教程</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: <!-- 文章内容页中的 Tags 部分 -->


<a class="tag" href="/tags/持久层/">#持久层</a> <a class="tag" href="/tags/Cayenne/">#Cayenne</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>Cayenne 是一个 Apache 下的持久层框架项目, 作用与 Hibernate /  mybatis 之类的持久层框架类似.<br> - 本文译自 <a href="https://cayenne.apache.org/docs/3.1/getting-started-guide" target="_blank" rel="noopener">Cayenne 3.1 版的官方文档 (Cayenne Getting Started Guide)</a><br> - 译文的目的是为初学者快速了解 Cayenne 减少一些语言障碍. 若要深入研究和使用 Cayenne 还是建议直接阅读官方原版文档. </p>
<p> - Apache Cayenne 官方已发布了 Cayenne 4.0 版本, 为方便小伙伴们学习, 我同样将 4.0 版的 “Cayenne Getting Started Guide” 译成中文了, 若没有特殊原因, 就别看这个教程了, 去看 “<a href="/2019/05/11/Cayenne入门指南4-0/">Cayenne 起步 (Version 4.0)</a>“吧</p>
<a id="more"></a>
<div class="toc">

<!-- toc -->
<ul>
<li><a href="#1-pei-zhi-huan-jing">1. 配置环境</a><ul>
<li><a href="#1-1-an-zhuang-java">1.1 安装Java</a></li>
<li><a href="#1-2-an-zhuang-eclipse-ide-he-maven-cha-jian">1.2 安装Eclipse IDE 和 Maven插件</a></li>
</ul>
</li>
<li><a href="#2-ying-she-mapping-ji-chu">2. 映射(mapping)基础</a><ul>
<li><a href="#2-1-kai-shi-yi-ge-xiang-mu">2.1. 开始一个项目</a></li>
<li><a href="#2-2-dui-xiang-guan-xi-ying-she-ru-men-orm">2.2. 对象关系映射入门（ORM）</a></li>
<li><a href="#2-3-chuang-jian-java-lei">2.3. 创建Java类</a></li>
</ul>
</li>
<li><a href="#3-xue-xi-cayenne-api">3. 学习Cayenne API</a><ul>
<li><a href="#3-1-objectcontext-ru-men">3.1. ObjectContext 入门</a></li>
<li><a href="#3-2-kai-shi-shi-yong-chi-jiu-ceng-dui-xiang">3.2. 开始使用持久层对象</a></li>
<li><a href="#3-3-jian-suo-dui-xiang">3.3. 检索对象</a></li>
<li><a href="#3-4-shan-chu-dui-xiang">3.4. 删除对象</a></li>
</ul>
</li>
<li><a href="#4-zhuan-huan-wei-web-ying-yong-cheng-xu">4. 转换为Web应用程序</a><ul>
<li><a href="#4-1-jiang-tutorial-xiang-mu-zhuan-huan-wei-web-ying-yong-cheng-xu">4.1. 将 tutorial 项目转换为 Web应用程序</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->
</div>

<p> - 另附对Cayenne的相关知识阐述更全面的 Cayenne Guide 链接: <a href="https://cayenne.apache.org/docs/3.1/cayenne-guide" target="_blank" rel="noopener">https://cayenne.apache.org/docs/3.1/cayenne-guide</a></p>
<h1><a href="#1-pei-zhi-huan-jing" class="header-anchor"></a><span id="1-pei-zhi-huan-jing">1. 配置环境</span></h1><p>本章的目标是安装（或检查您是否已安装）构建Cayenne应用程序所需的最低软件环境.</p>
<h2><a href="#1-1-an-zhuang-java" class="header-anchor"></a><span id="1-1-an-zhuang-java">1.1 安装Java</span></h2><p>显然，JDK 必须安装. Cayenne 3.1需要 JDK 1.5 或 更高版本.</p>
<h2><a href="#1-2-an-zhuang-eclipse-ide-he-maven-cha-jian" class="header-anchor"></a><span id="1-2-an-zhuang-eclipse-ide-he-maven-cha-jian">1.2 安装Eclipse IDE 和 Maven插件</span></h2><blockquote>
<p><small style="color:gray;">译注: Maven是一个项目管理工具, 本教程主要使用它来进行项目所依赖的 jar 的管理(自动下载)</small></p>
</blockquote>
<p>下载Eclipse. 本教程基于Galileo JEE版本的Eclipse(Eclipse 3.5), 但它同样适用于最新的其它Eclipse通用版本. Eclipse下载完后, 解压并运行之. </p>
<p>对本教程而言, 你唯一需要安装的插件是m2eclipse. </p>
<p>选择Eclipse菜单 “Help &gt; Install New Software”, 然后点击 “Add…” 添加一个新的下载站点(download site), 在 “Name” 输入框中输入 “Maven”, “Location”框中输入<a href="http://m2eclipse.sonatype.org/sites/m2e" target="_blank" rel="noopener">http://m2eclipse.sonatype.org/sites/m2e</a>. </p>
<p>你可以选择任何你想要的可选组件, 但是对本教程而言, 你只需要选择最少的基本组件即可, 如下图:<br><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/maven-plugin-install.png" alt=""></p>
<p>按照Eclipse对话框中的提示, 完成安装.</p>
<h1><a href="#2-ying-she-mapping-ji-chu" class="header-anchor"></a><span id="2-ying-she-mapping-ji-chu">2. 映射(mapping)基础</span></h1><h2><a href="#2-1-kai-shi-yi-ge-xiang-mu" class="header-anchor"></a><span id="2-1-kai-shi-yi-ge-xiang-mu">2.1. 开始一个项目</span></h2><p>本章目标是创建一个包含基本Cayenne映射(Cayenne mapping)的Java项目. 其中展示 CayenneModeler 图形化工具的使用,<br>演示如何创建初始的映射对象: <code>DataDomain</code>, <code>DataNode</code>, <code>DataMap</code>.</p>
<blockquote>
<p><small style="color:gray;">译注: CayenneModeler 是 Cayenne的一个图形化建模工具, 使用此工具可比较直观且自动化地创建 Cayenne 持久层对象模型所需各类文件</small></p>
</blockquote>
<h4><a href="#zai-eclipse-zhong-chuang-jian-yi-ge-xin-xiang-mu" class="header-anchor"></a><span id="zai-eclipse-zhong-chuang-jian-yi-ge-xin-xiang-mu"><strong>在Eclipse中创建一个新项目</strong></span></h4><p>在Eclipse中选择 “File &gt; New &gt; Other…​”,  “Maven &gt; Maven Project”.<br>点击 “Next”. </p>
<p>在接下来的界面中选中 “Create a simple project” 复选框, 再次点击 “Next”.<br>对话框中显示如下图所示内容, 填写 “Group Id” 和 “Artifact Id” 并点击 “Finish”.<br><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/tutorial-idea-project.png" alt=""></p>
<p>现在, 在Eclipse的workspace里应该有一个空的项目. 检查一下这个项目的Java编译设置是否正确.<br>右键单击 “tutorial” 项目, 选择 “Properties &gt; Java Compiler”, 确保 “Compiler compliance level”<br>至少为 “1.5” (一些版本的Maven插件似乎会默认将其设置为1.4)</p>
<h4><a href="#xia-zai-bing-yun-xing-cayennemodeler" class="header-anchor"></a><span id="xia-zai-bing-yun-xing-cayennemodeler"><strong>下载并运行CayenneModeler</strong></span></h4><p>尽管在本教程中稍后我们将使用Maven来导入Cayenne的运行时所需的jar文件到项目中, 你仍然需要下载Cayenne 以便可以使用 CayenneModeler 工具.</p>
<blockquote>
<p><small>如果你直接使用Maven, 你也可以从Maven直接启动CayenneModeler. 这里我们使用更传统的文件来做.</small></p>
</blockquote>
<p>下载最新的发布版. 解压到任意位置, 根据特定操作系统平台的要求启动 CayenneModeler.</p>
<p>在大多数平台下, 只需要简单地双击 Modeler 的图标即可.<br>Modeler的欢迎界面如下图:<br><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/modeler-started.png" alt=""></p>
<h4><a href="#zai-cayennemodeler-zhong-chuang-jian-yi-ge-xin-de-ying-she-xiang-mu-mapping-project" class="header-anchor"></a><span id="zai-cayennemodeler-zhong-chuang-jian-yi-ge-xin-de-ying-she-xiang-mu-mapping-project"><strong>在 CayenneModeler 中创建一个新的映射项目(Mapping Project)</strong></span></h4><p>在欢迎界面中点击 <code>New Project</code> 按钮即会出现一个新的 <strong>Mapping</strong> 项目, 并包含一个<strong>DataDomain</strong>. </p>
<p>DataDomain 的含意将会在本教程的其他地方解释.<br>现在你只需要知道 DataDomain 是你的Mapping项目的根.</p>
<h4><a href="#chuang-jian-yi-ge-datanode" class="header-anchor"></a><span id="chuang-jian-yi-ge-datanode"><strong>创建一个DataNode</strong></span></h4><p>你需要创建的下一个项目对象是 <strong>DataNode</strong>.</p>
<p>DataNode 是你应用程序将要连接的单个数据库的描述.<br>Cayenne 的 mapping 项目可应用于多于一个数据库的情况, 但是现在我们仅使用一个数据库.</p>
<p>选中左侧的 “project”, 点击工具栏上的 <code>Create DataNode</code> 按钮 ( 或者在菜单中选择<code>Project &gt; Create DateNode</code> ), 一个新的DataNode就出现了. </p>
<p>现在你需要指定JDBC连接参数.<br>如果使用内存型数据库 Derby, 那你可以输入如下的配置:</p>
<ul>
<li><code>JDBC Driver: org.apache.derby.jdbc.EmbeddedDriver</code></li>
<li><code>DB URL: jdbc:derby:memory:testdb;create=true</code></li>
</ul>
<blockquote>
<p><small>这里我们创建了一个内存型数据库(in-memory database). 因此, 当你停止你的程序时, 所有的数据将会丢失. 在更多实际的项目中, 你应该会连接一个实际将数据存储于磁盘的数据库, 但是对于这个简单的教程而言, 我们将使用内存数据库.<br></small></p>
</blockquote>
<blockquote>
<p><small style="color:gray;">译注: 与传统的数据库(如mysql)不同, 内存型数据库可直接将数据加载到内存中来运行, 可理解为一个直接在内存中运行的关系型数据库. 本教程使用 Derby, 并在 DB URL 处配置 <em>create=true</em>, 这样可根据 CayenneModeler 建立的模型来自动生成数据库.<br></small></p>
</blockquote>
<p>同时, 你需要更改 “Schema Update Strategy”. </p>
<p>在下拉列框中选择 <code>org.apache.cayenne.access.dbsync.CreateIfNoSchemaStrategy</code>,<br>这样当程序启动时, Cayenne 将会根据对象关系模型映射(ORM mapping)信息在Derby中创建一个新的数据库模式(Schema).<br><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/base-datanode.png" alt=""></p>
<h4><a href="#chuang-jian-yi-ge-datamap" class="header-anchor"></a><span id="chuang-jian-yi-ge-datamap"><strong>创建一个DataMap</strong></span></h4><p>现在, 你将要创建一个 <strong>DataMap</strong>. </p>
<p>DataMap 是一个包含了所有映射信息的对象. 点击工具栏上的 “Create DataMap” 按钮 (或选择相应的菜单项).</p>
<p>注意, 新创建的 DataMap 将自动关联到上一步骤中创建的 DataNode. 如果有多于一个DataNode, 你应该手动关联 DataMap 到正确的 DataNode. 也就是说, 在 DataDomain 中的一个 DataMap 必须通过指定关联来指向一个数据库描述.</p>
<p>在DataMap的配置中, 除了 “Java Package”, 你都可以保留DataMap的默认配置.</p>
<p>在 “Java Package” 框中输入 “org.example.cayenne.persistent”. 这个包名将在随后应用于所有的持久层类.</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/base-datamap.png" alt=""></p>
<h4><a href="#bao-cun-xiang-mu" class="header-anchor"></a><span id="bao-cun-xiang-mu"><strong>保存项目</strong></span></h4><p>在你进行实际的映射配置之前, 让我们先保存一下这个项目.</p>
<p>点击工具栏上的 “Save” 按钮, 并指定保存路径到本章前面创建的名为 “tutorial” 的 Eclipse 项目的文件夹中的子文件夹 “src/main/resources”, 并将项目保存在这里.</p>
<p>现在, 回到 Eclipse, 右键点击 “tutorial” 项目, 并选择 “Refresh(刷新)”, 你将看到3个 Cayenne 的 XML 文件. <small style="color:gray">( 译注: 原文为3个, 但我只看到2个)</small></p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/eclipse-xmlfiles.png" alt=""></p>
<p>注意, XML文件的存放位置不是随意的. Cayenne 运行时将在应用程序的 <code>CLASSPATH</code> 寻找 <code>cayenne-*.xml</code> 文件.</p>
<p><code>src/main/resources</code> 文件夹应成为Eclipse中我们项目的”class folder”.<br>( 如果我们以命令行方式使用Maven, 那上述位置也是 Maven 复制 jar 文件的标准目标位置 )</p>
<blockquote>
<p><small style="color:gray">译注: 按前面一段的步骤保存项目文件到 “src/main/resources” 就行了, 对于 Eclipse 中创建的 Maven 项目 “src/main/resources” 默认就是在CLASSPATH中的. 如果你没有使用 Maven, 可直接保存到 src 根目录即可.<br></small></p>
</blockquote>
<h2><a href="#2-2-dui-xiang-guan-xi-ying-she-ru-men-orm" class="header-anchor"></a><span id="2-2-dui-xiang-guan-xi-ying-she-ru-men-orm">2.2. 对象关系映射入门（ORM）</span></h2><p>本节的目标是学会怎么使用 CayenneModeler 来创建一个简单的对象关系模型 ( Object-Relational model, ORM ). </p>
<p>我们将为以下数据库模式创建一个完整的 ORM 模型：</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/cayenne-tutorial-model.png" alt="数据库模式"></p>
<blockquote>
<p><small>通常情况下, 你已经有创建好了的数据库, 那你可以通过菜单 “Tools &gt; Reengineer Database Schema” 将其快速导入到 Cayenne 中. 相比手工映射, 这将节省你很多时间. 但是, 懂得如何手工创建映射同样重要,<br>因此, 我们下面将演示手工操作的方法.<br></small></p>
</blockquote>
<h4><a href="#ying-she-shu-ju-ku-biao-he-lie" class="header-anchor"></a><span id="ying-she-shu-ju-ku-biao-he-lie"><strong>映射数据库表和列</strong></span></h4><p>让我们回到 CayenneModeler, 打开新我们新创建的项目, 并开始添加 ARTIST 表. </p>
<p>在 Cayenne 映射中, 数据库表被称作 DbEntities ( 可以是实际的表或视图 ).</p>
<p>在左边项目树中选中 “datamap”, 点击工具栏上的 “Create DbEntity” 按钮 ( 或使用菜单 “Project &gt; Create DbEntity” ), 一个新的 DbEntity 即被创建出来了.</p>
<p>在 “DbEntity Name” 字段输入 “ARTIST”. 然后点击实体工具栏(entity toolbar, <small style="color:gray">译注:就是下图右侧详情区域上方的二级工具栏</small> ) 上的 “Create Attribute” 按钮切换到 “Attribute” 标签页, 并新增一个名叫 “untitledAttr” 的属性( Attribute, 这里的 attribute 对应一个表中的列 ).</p>
<p>让我们将其重命名为ID, 并设置为 <code>INTEGER</code> 和 ‘PK’ ( 主键 ):</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/modeler-artistid.png" alt=""></p>
<p>类似地, 增加 NAME <code>VARCHAR(200)</code> 和 DATE_OF_BIRTH <code>DATE</code> 属性.</p>
<p>然后, 重复上述过程, 创建如前面数据库模式图中所示的 PAINTING 和 GALLERY 实体.</p>
<blockquote>
<p><small>不要忘记定期保存你的项目, 以免丢失你所做的工作.<br>因为 Eclipse 默认情况下并不会自动感知建模工具中所做的修改, 所以, 每次 CayenneModeler 保存后,<br>你都应该在 Eclipse 中刷新项目.<br></small></p>
</blockquote>
<h4><a href="#ying-she-shu-ju-ku-guan-xi" class="header-anchor"></a><span id="ying-she-shu-ju-ku-guan-xi"><strong>映射数据库关系</strong></span></h4><p>现在我们需要指定 ARTIST, PAINTING 和 GALLERY 表之间的 ( 外键 ) 关系. </p>
<p>首先创建一对多的 ARTIST/PAINTING 关系:</p>
<ul>
<li>选择左边的 ARTIST DbEntity, 并点击 “Relationship” 标签页</li>
<li>点击实体工具栏上的 “Create Relationship” 按钮 <img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/icon-relationship.png" alt="">, 一个名为 “untitledRel” 的关系即被创建出来.</li>
<li>选择 “Target” 为 “PAINTING”</li>
<li>点击右侧工具栏上的 “Database Mapping” 按钮, 即会弹出关系配置对话框.<br>在这里你可以给关系取个名字, 同样也可以给反向关系取名. 这个名字可以任取 ( 这实际上是数据库参考约束的一个符号名称 ), 但是, 更推荐使用 Java 标识符, 因为稍后这个名字将被以同样的拼写方式保存下来. 我们将这个关系称作”paintings”, 反向<br>关系称作 “artist”.<br><small style="color:gray">译注: 这里的关系即 ARTIST 表和 PAINTING 表之间一对多的外键约束, 关系名称即对于一个 ARTIST 来说 PAINTING 表的数据是它的什么, 而反向关系即: 对于一个 PAINTING 来说, ARTIST 是它的什么. 呵呵, 有点绕~ 简单说, 对于一个艺术家( ARTIST ) 而言PAINTING 表中的数据是它的画作, 而对于 PAINTING 表中的一条数据而言, ARTIST 表的对应数据是这幅画的作者</small></li>
<li>点击右边的 “Add” 按钮</li>
<li>“Source” 选择 “ID” 列, “Target” 选择 “ARTIST_ID” 列</li>
<li><p>关系信息应如下图所示:</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/modeler-dbrelationship.png" alt=""></p>
</li>
<li><p>点击 “Done” 以确认所做的修改并关闭对话框.</p>
</li>
<li>两个关系已经被创建: 从 ARTIST 到 PAINTING 的关系, 以及反向的关系. 不过你可能注意到有件事<br>忘记了: “paintings” 关系应该是 to-many, 但是 “To Many” 复选框并没有选中.<br>让我们来改一下: 选中 “paintings” 关系的 “To Many” 复选框, 同时, 点击 PAINTING DBEntity, 取消 “artist” 关系的 “To Many” 复选框以设置反向关系, 因为反向的 PAINTING 指向 ARTIST 的关系应该是多对一(to-one).</li>
<li>重复前面的步骤, 以建立从 PAINTING 到 GALLERY 的多对一关系, 让我们将这对关系命名为 “gallery” 和 “paintings”.</li>
</ul>
<h4><a href="#ying-she-java-lei" class="header-anchor"></a><span id="ying-she-java-lei"><strong>映射 Java 类</strong></span></h4><p>现在, 数据库模式已经映射完成, CayenneModeler 可以根据DbEntity中的所有内容来创建Java类的映射(又称作 “ObjEntity”).</p>
<p>目前还不能直接通过一次点击就完所有的 DataMap 映射, 因此我们将逐个表来做.</p>
<ul>
<li>选择 “ARTIST” DbEntity 并点击实体工具栏或主工具栏上的 “Create ObjEntity” 按钮,  一个名为 “Artist” 的 ObjEntity 即被创建出来, 同时 Java class 输入框的值被设置为 “org.example.cayenne.Artist”.  建模工具会将数据库中的名称转换为 Java 风格的名称 ( 例如: 如果你点击 “Attributes” 标签页, 将看到  “DATA_OF_BIRTH” 列被转换为 Java 类属性 “dateOfBirth” ).</li>
<li>选择 “GALLERY” DbEntity 并再次点击 “Create ObjEntity” 按钮, 你将看到一个 “Gallery” ObjEntity 被创建出来.</li>
<li>最后, 为 “PAINTING” 做同样的操作.</li>
</ul>
<p>现在, 你需要同步关系. 因为在还没有相关联的 “Painting” 实体 ( objEntity ) 之前, Artist 和 Gallery 实体就已经被创建出来了. 因此, 他们之间的关系并未被自动设置.</p>
<ul>
<li>点击 “Artist” ObjEntity. 点击工具栏上的 “Sync ObjEntity with DbEntity” 按钮, 你会看到出现了 “paintings” 关系</li>
<li>对 “Gallery”  实体做同样的操作.</li>
</ul>
<p>除非你想要自定义 Java 类和属性名 ( 你可以很容易地做到 ), 映射已经完成了.</p>
<h2><a href="#2-3-chuang-jian-java-lei" class="header-anchor"></a><span id="2-3-chuang-jian-java-lei">2.3. 创建Java类</span></h2><p>这里我们将根据前面章节中创建的模型生成 Java 类. </p>
<p>CayenneModeler 同样可用来生成数据库模式, 因为在我们先前创建 DataNode 的时候指定了 “CreateIfNoSchemaStrategy”, 因此我们将跳过创建数据库模式的步骤. <small style="color:gray">( 译注: 因为设置了CreateIfNoSchemaStrategy策略, 建模工具会自动创建相应的数据库模式 )</small> </p>
<p>如果你有需要, 可通过 “Tools &gt; Create Database Schema” 做到这一点 ( 生成数据库模式 ).</p>
<h4><a href="#chuang-jian-java-lei" class="header-anchor"></a><span id="chuang-jian-java-lei"><strong>创建 Java 类</strong></span></h4><ul>
<li>选择 “Tools &gt; Generate Classes” 菜单</li>
<li>“Type” 选择 “Standard Persistent Objects” ( 如果没有选中的话 )</li>
<li>“Output Directory” 选择你项目下的 “src/main/java” 文件夹 ( 这是与之前我们为 cayenne-*.xml 选择的位置同等的位置 )</li>
<li>点击 “Classess” 标签, 选中 “Check All Classes” 复选框</li>
<li>点击 “Generate”</li>
</ul>
<p>现在回到 Eclipse, 右键点击 “tutorial” 项目选择 “Refresh” - 你应该看到每个被映射的实体生成了两个类.你可能也注意到, 有一堆红色的波浪线在 Eclipse 中新出现的 Java 类旁边.</p>
<blockquote>
<p><small>译注: 应该是红色的小叉叉吧~</small></p>
</blockquote>
<p>这是因为我们的项目还没有将 Cayenne 作为 Maven 的依赖包含进来.<br>让我们来修复它, 在 pom.xml 文件的最下面插入 “cayenne-server” artifact.<br>最终的POM应该像这样:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example.cayenne<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tutorial<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cayenne<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cayenne-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 在这里指定你实际想使用的 Cayenne 版本. 译注: 建议使用3.1.1这样的RELEASE版本, 而不是SNAPSHOT版本 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>你的电脑必须连上Internet.<br>一旦你保存了 pom.xml, Eclipse 会自动下载 Cayenne 所需的 jar 文件, 并将其添加到项目构建路径 ( build path ).</p>
<p>最终, 所有的错误就消失了.</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/eclipse-generatedclasses.png" alt=""></p>
<p>现在, 让我们来看一下实体类. 每个实体都有一个父类 ( 如: _Artist ) 和一个子类 ( 如: Artist ).</p>
<p>你不应该修改名称以”_” ( 下划线 ) 开头的父类, 因为他们将会在后续生成器运行的时候被覆盖. 应该把所有的自定义逻辑放在 “org.example.cayenne.persistent” 包的子类中(Artist), 这些子类不会被类生成器覆盖.</p>
<blockquote>
<p><small><strong>类生成提示</strong><br><br>通常你会先从 CayenneModeler 生成类, 但是在项目的后期阶段, 通常通过Ant cgen task 或 Maven cgen mojo 自动生成代码. 这三种方法均可, 但 Ant 和 Maven 方法可以确保您不会忘记在映射更改时重新生成类, 因为它们已集成到构建周期中.<br></small> </p>
</blockquote>
<h1><a href="#3-xue-xi-cayenne-api" class="header-anchor"></a><span id="3-xue-xi-cayenne-api">3. 学习Cayenne API</span></h1><h2><a href="#3-1-objectcontext-ru-men" class="header-anchor"></a><span id="3-1-objectcontext-ru-men">3.1. ObjectContext 入门</span></h2><p>本节我们将写一个简单的 main 类来运行我们的应用程序, 并对 Cayenne ObjectContext 作简单的介绍.</p>
<h4><a href="#chuang-jian-main-lei" class="header-anchor"></a><span id="chuang-jian-main-lei"><strong>创建 Main 类</strong></span></h4><ul>
<li>Eclipse中, 在 “org.example.cayenne” 包中创建一个新的类, 命名为 “Main”</li>
<li><p>创建一个标准的 “main” 方法, 以使其成为一个可运行的类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.cayenne;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>要访问数据库首先要做的是创建一个 <code>ServerRuntime</code> 对象 ( 这实质上是对Cayenne的一个封装 ), 并使用它获得一个 <code>ObjectContext</code> 的实例.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.cayenne;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.cayenne.ObjectContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.cayenne.configuration.server.ServerRuntime;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ServerRuntime cayenneRuntime = <span class="keyword">new</span> ServerRuntime(</span><br><span class="line">                        <span class="string">"cayenne-project.xml"</span>);</span><br><span class="line">        ObjectContext context = cayenneRuntime.getContext();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在 Cayenne 中, <code>ObjectContext</code> 是一个独立的 “Session”, 它提供了处理数据所需的所有API.</p>
<p>ObjectContext 拥有执行查询和管理持久层对象的方法. 我们将在后续的章节中讨论它们.</p>
<p>当应用程序中的第一个 ObjectContext 被创建时, Cayenne 将加载 XML 映射文件, 并创建共享的访问接口, 这将可被后续创建的其它 ObjectContext 重用.</p>
<h4><a href="#yun-xing-ying-yong-cheng-xu" class="header-anchor"></a><span id="yun-xing-ying-yong-cheng-xu"><strong>运行应用程序</strong></span></h4><p>让我们来看一下运行程序时发生了什么.</p>
<p>但是在此之前, 我们需要添加其它的依赖 ( Apache Derby - 我们的嵌入式数据库引擎 ) 到 <code>pom.xml</code>.</p>
<p>下面这段XML代码需要添加到 <code>&lt;dependencies&gt;…​&lt;/dependencies&gt;</code> 部分, 在这里我们之前已经添加过 Cayenne 所需的 jar:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.derby<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>derby<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>10.8.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>现在我们可以运行了. </p>
<p>在 Eclipse 中右键单击 “Main” 类, 选择”Run As &gt; Java Application”.</p>
<p>在控制台你将看到类似如下的输出. 这表示 Cayenne 已经被启动起来了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INFO: Loading XML configuration resource from file:cayenne-project.xml</span><br><span class="line">INFO: loading user name and password.</span><br><span class="line">INFO: Created connection pool: jdbc:derby:memory:testdb;create=true</span><br><span class="line">    Driver class: org.apache.derby.jdbc.EmbeddedDriver</span><br><span class="line">    Min. connections in the pool: 1</span><br><span class="line">    Max. connections in the pool: 1</span><br></pre></td></tr></table></figure></p>
<h4><a href="#ru-he-pei-zhi-cayenne-de-ri-zhi" class="header-anchor"></a><span id="ru-he-pei-zhi-cayenne-de-ri-zhi"><strong>如何配置Cayenne的日志</strong></span></h4><p>按照日志一章中的介绍, 调整日志记录输出的详尽程度. </p>
<blockquote>
<p><small style="color:gray">译注: 我没找到所谓”日志一章”</small></p>
</blockquote>
<h2><a href="#3-2-kai-shi-shi-yong-chi-jiu-ceng-dui-xiang" class="header-anchor"></a><span id="3-2-kai-shi-shi-yong-chi-jiu-ceng-dui-xiang">3.2. 开始使用持久层对象</span></h2><p>本节我们将学习关于持久层对象的知识, 如何定义它们, 如何创建并将其保存到数据库.</p>
<h4><a href="#jian-shi-he-ding-yi-chi-jiu-ceng-dui-xiang" class="header-anchor"></a><span id="jian-shi-he-ding-yi-chi-jiu-ceng-dui-xiang"><strong>检视和定义持久层对象</strong></span></h4><p>在 Cayenne 中持久层类实现了一个数据对象 ( DataObject ) 接口.</p>
<p>如果你查看本教程此前生成的任何一个类 ( 如:org.example.cayenne.Artist ), 你会看到它继承了一个名称以下划线开头的类( 如: org.example.cayenne._Artist), 而这个类又继承了  org.apache.cayenne.CayenneDataObject.</p>
<p>将每一个持久层类分解为一个用户自定义子类 ( Xyz ) 和一个自动生成的父类 ( _Xyz ) 是一个很有用的技术, 它将避免在刷新映射模型时覆盖自定义的代码.</p>
<p>让我们来举个例子, 添加一个工具方法到 Artist 类中, 用于设置出生日期. 此方法接收一个字符型的日期参数. 即使后续模型发生变化, 这个方法亦将被保护 ( 避免被建模工具修改 ) :<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Artist</span> <span class="keyword">extends</span> <span class="title">_Artist</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_DATE_FORMAT = <span class="string">"yyyyMMdd"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Sets date of birth using a string in format yyyyMMdd.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDateOfBirthString</span><span class="params">(String yearMonthDay)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (yearMonthDay == <span class="keyword">null</span>) &#123;</span><br><span class="line">			setDateOfBirth(<span class="keyword">null</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Date date;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				date = <span class="keyword">new</span> SimpleDateFormat(DEFAULT_DATE_FORMAT)</span><br><span class="line">						.parse(yearMonthDay);</span><br><span class="line">			&#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">						<span class="string">"A date argument must be in format '"</span></span><br><span class="line">								+ DEFAULT_DATE_FORMAT + <span class="string">"': "</span> + yearMonthDay);</span><br><span class="line">			&#125;</span><br><span class="line">			setDateOfBirth(date);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4><a href="#chuang-jian-xin-dui-xiang" class="header-anchor"></a><span id="chuang-jian-xin-dui-xiang"><strong>创建新对象</strong></span></h4><p>现在我们将创建一组对象, 并将其保存到数据库.</p>
<p>使用 <code>ObjectContext</code> 的”newObject”方法可创建并注册一个对象.</p>
<p>对象必须被注册到 <code>DataContext</code> 才能被持久化, 也才能被允许设置与其它对象的关系.</p>
<p>添加如下代码到 Main 类的 “main” 方法中:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Artist picasso = context.newObject(Artist.class);</span><br><span class="line">picasso.setName(<span class="string">"Pablo Picasso"</span>);</span><br><span class="line">picasso.setDateOfBirthString(<span class="string">"18811025"</span>);</span><br></pre></td></tr></table></figure></p>
<p>注意, 此时对象 picasso 仅被存储于内存中, 还未被保存到数据库.</p>
<p>让我们继续添加一个名为 Metropolitan Museum 的 “Gallery” 对象, 和一些毕加索的画作( Paintings ).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Gallery metropolitan = context.newObject(Gallery.class);</span><br><span class="line">metropolitan.setName(<span class="string">"Metropolitan Museum of Art"</span>);</span><br><span class="line"></span><br><span class="line">Painting girl = context.newObject(Painting.class);</span><br><span class="line">girl.setName(<span class="string">"Girl Reading at a Table"</span>);</span><br><span class="line"></span><br><span class="line">Painting stein = context.newObject(Painting.class);</span><br><span class="line">stein.setName(<span class="string">"Gertrude Stein"</span>);</span><br></pre></td></tr></table></figure></p>
<p>现在我们可以把这些对象关联起来, 建立关系. </p>
<p>注意, 在下面的每一个例子里, 双向的关系均被自动建立起来. ( 例如: picasso.addToPaintings(girl) 完全等效于 girl.setToArtist(picasso) ).<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">picasso.addToPaintings(girl);</span><br><span class="line">picasso.addToPaintings(stein);</span><br><span class="line"></span><br><span class="line">girl.setGallery(metropolitan);</span><br><span class="line">stein.setGallery(metropolitan);</span><br></pre></td></tr></table></figure></p>
<p>现在, 让我们使用一个方法来同时保存所有的5个对象:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.commitChanges();</span><br></pre></td></tr></table></figure></p>
<p>现在, 你可以使用前面章节中所述的方法的来再次运行程序.</p>
<p>新的输出将显示一些实际的数据库操作:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">org.apache.cayenne.configuration.XMLDataChannelDescriptorLoader load</span><br><span class="line">INFO: Loading XML configuration resource from file:cayenne-project.xml</span><br><span class="line">...</span><br><span class="line">INFO: Opening connection: jdbc:derby:memory:testdb;create=true</span><br><span class="line">    Login: null</span><br><span class="line">    Password: *******</span><br><span class="line">INFO: +++ Connecting: SUCCESS.</span><br><span class="line">INFO: Detected and installed adapter: org.apache.cayenne.dba.derby.DerbyAdapter</span><br><span class="line">INFO: --- transaction started.</span><br><span class="line">INFO: No schema detected, will create mapped tables</span><br><span class="line">INFO: CREATE TABLE GALLERY (ID INTEGER NOT NULL, NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: CREATE TABLE ARTIST (DATE_OF_BIRTH DATE, ID INTEGER NOT NULL, NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: CREATE TABLE PAINTING (ARTIST_ID INTEGER, GALLERY_ID INTEGER, ID INTEGER NOT NULL,</span><br><span class="line">      NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: ALTER TABLE PAINTING ADD FOREIGN KEY (ARTIST_ID) REFERENCES ARTIST (ID)</span><br><span class="line">INFO: ALTER TABLE PAINTING ADD FOREIGN KEY (GALLERY_ID) REFERENCES GALLERY (ID)</span><br><span class="line">INFO: CREATE TABLE AUTO_PK_SUPPORT (</span><br><span class="line">      TABLE_NAME CHAR(100) NOT NULL,  NEXT_ID BIGINT NOT NULL,  PRIMARY KEY(TABLE_NAME))</span><br><span class="line">INFO: DELETE FROM AUTO_PK_SUPPORT WHERE TABLE_NAME IN (&apos;ARTIST&apos;, &apos;GALLERY&apos;, &apos;PAINTING&apos;)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;ARTIST&apos;, 200)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;GALLERY&apos;, 200)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;PAINTING&apos;, 200)</span><br><span class="line">INFO: SELECT NEXT_ID FROM AUTO_PK_SUPPORT WHERE TABLE_NAME = ? FOR UPDATE [bind: 1:&apos;ARTIST&apos;]</span><br><span class="line">INFO: SELECT NEXT_ID FROM AUTO_PK_SUPPORT WHERE TABLE_NAME = ? FOR UPDATE [bind: 1:&apos;GALLERY&apos;]</span><br><span class="line">INFO: SELECT NEXT_ID FROM AUTO_PK_SUPPORT WHERE TABLE_NAME = ? FOR UPDATE [bind: 1:&apos;PAINTING&apos;]</span><br><span class="line">INFO: INSERT INTO GALLERY (ID, NAME) VALUES (?, ?)</span><br><span class="line">INFO: [batch bind: 1-&gt;ID:200, 2-&gt;NAME:&apos;Metropolitan Museum of Art&apos;]</span><br><span class="line">INFO: === updated 1 row.</span><br><span class="line">INFO: INSERT INTO ARTIST (DATE_OF_BIRTH, ID, NAME) VALUES (?, ?, ?)</span><br><span class="line">INFO: [batch bind: 1-&gt;DATE_OF_BIRTH:&apos;1881-10-25 00:00:00.0&apos;, 2-&gt;ID:200, 3-&gt;NAME:&apos;Pablo Picasso&apos;]</span><br><span class="line">INFO: === updated 1 row.</span><br><span class="line">INFO: INSERT INTO PAINTING (ARTIST_ID, GALLERY_ID, ID, NAME) VALUES (?, ?, ?, ?)</span><br><span class="line">INFO: [batch bind: 1-&gt;ARTIST_ID:200, 2-&gt;GALLERY_ID:200, 3-&gt;ID:200, 4-&gt;NAME:&apos;Gertrude Stein&apos;]</span><br><span class="line">INFO: [batch bind: 1-&gt;ARTIST_ID:200, 2-&gt;GALLERY_ID:200, 3-&gt;ID:201, 4-&gt;NAME:&apos;Girl Reading at a Table&apos;]</span><br><span class="line">INFO: === updated 2 rows.</span><br><span class="line">INFO: +++ transaction committed.</span><br></pre></td></tr></table></figure></p>
<p>Cayenne 创建了必要的表 ( 记住, 我们使用了 “CreateIfNoSchemaStrategy”).</p>
<p>然后它运行一些插入, 即时生成了主键. </p>
<p>就这么几行代码就搞成这样还不赖.</p>
<h2><a href="#3-3-jian-suo-dui-xiang" class="header-anchor"></a><span id="3-3-jian-suo-dui-xiang">3.3. 检索对象</span></h2><p>本节演示如何使用 <code>ObjectSelect</code> 来从数据库中检索 ( 查询 ) 对象.</p>
<h4><a href="#objectselect-jie-shao" class="header-anchor"></a><span id="objectselect-jie-shao"><strong>ObjectSelect 介绍</strong></span></h4><p>前面已经展示了如何持久化新的对象. </p>
<p>Cayenne 的 query 被用来访问已经保存的对象. </p>
<p>用于检索对象的主要查询类型是 <code>ObjectSelect</code>. 它可以直接在 CayenneModeler 中进行映射, 也可以通过 API 创建. 本节我们将使用后一种方法.</p>
<p>虽然我们还没有太多的数据在数据库中, 但是我们仍可以演示如下的主要方法.</p>
<ul>
<li>检索所有的画作 ( 代码 及 产生的日志输出 ):</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SelectQuery select1 = <span class="keyword">new</span> SelectQuery(Painting.class);</span><br><span class="line">List paintings1 = context.performQuery(select1);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INFO: SELECT t0.GALLERY_ID, t0.ARTIST_ID, t0.NAME, t0.ID FROM PAINTING t0</span><br><span class="line">INFO: === returned 2 rows. - took 18 ms.</span><br></pre></td></tr></table></figure>
<ul>
<li>检索以 “gi” 开头的画作, 忽略大小写:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Expression qualifier2 = ExpressionFactory.likeIgnoreCaseExp(</span><br><span class="line">                Painting.NAME_PROPERTY,</span><br><span class="line">                <span class="string">"gi%"</span>);</span><br><span class="line">SelectQuery select2 = <span class="keyword">new</span> SelectQuery(Painting.class, qualifier2);</span><br><span class="line">List paintings2 = context.performQuery(select2);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO: SELECT t0.GALLERY_ID, t0.NAME, t0.ARTIST_ID, t0.ID FROM PAINTING t0 WHERE UPPER(t0.NAME) LIKE UPPER(?)</span><br><span class="line">      [bind: 1-&gt;NAME:&apos;gi%&apos;] - prepared in 6 ms.</span><br><span class="line">INFO: === returned 1 row. - took 18 ms.</span><br></pre></td></tr></table></figure>
<ul>
<li>检索所有100年前出生的艺术家的画作 ( 演示使用 Expression.fromString(..) 而不是 ExpressionFactory ):</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Calendar c = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">c.set(c.get(Calendar.YEAR) - <span class="number">100</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">Expression qualifier3 = Expression.fromString(<span class="string">"artist.dateOfBirth &lt; $date"</span>);</span><br><span class="line">qualifier3 = qualifier3.expWithParameters(Collections.singletonMap(<span class="string">"date"</span>, c.getTime()));</span><br><span class="line">SelectQuery select3 = <span class="keyword">new</span> SelectQuery(Painting.class, qualifier3);</span><br><span class="line">List paintings3 = context.performQuery(select3);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO: SELECT t0.GALLERY_ID, t0.NAME, t0.ARTIST_ID, t0.ID FROM PAINTING t0 JOIN ARTIST t1 ON (t0.ARTIST_ID = t1.ID)</span><br><span class="line">      WHERE t1.DATE_OF_BIRTH &lt; ? [bind: 1-&gt;DATE_OF_BIRTH:&apos;1911-01-01 00:00:00.493&apos;] - prepared in 7 ms.</span><br><span class="line">INFO: === returned 2 rows. - took 25 ms.</span><br></pre></td></tr></table></figure>
<h2><a href="#3-4-shan-chu-dui-xiang" class="header-anchor"></a><span id="3-4-shan-chu-dui-xiang">3.4. 删除对象</span></h2><p>本节解释如何建立关系的删除约束模型, 如何删除单个对象和一组对象. </p>
<p>同时, 也将演示执行查询时 Cayenne 类的使用.</p>
<h4><a href="#she-zhi-shan-chu-yue-shu" class="header-anchor"></a><span id="she-zhi-shan-chu-yue-shu"><strong>设置删除约束</strong></span></h4><p>在我们讨论删除对象的 API 前, 让我们回到 CayenneModeler, 进行一些删除约束的设置.</p>
<p>这样做是可选的 ( 不是必须的 ) , 但它将使得我们可以以简单的方式正确处理与被删除对象相关联的其它对象.</p>
<p>在建模工具中转到 “Artist” ObjEntity 的 “Relationships” 标签页, 为 “paintings” 关系选择 “Cascade” ( 级联 ) 删除约束:</p>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/modeler-deleterule.png" alt=""></p>
<p>为其它关系重复上述步骤:</p>
<ul>
<li>为 Gallery 设置 “paintings” 关系为 “Nullify”, 因为可以存在一副画作未在任何画廊展出的情况.</li>
<li>为 Painting 设置其两个关系的删除约束均为 “Nullify”.</li>
</ul>
<p>现在, 保存映射.</p>
<h4><a href="#shan-chu-dui-xiang" class="header-anchor"></a><span id="shan-chu-dui-xiang"><strong>删除对象</strong></span></h4><p>虽然可以通过SQL删除对象. 但在Cayenne（ 或一般的ORM ）中更常用的方法是首先获取对象, 然后通过 context 删除它.</p>
<p>让我们使用 Cayenne 的工具类找到一个艺术家:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Expression qualifier = ExpressionFactory.matchExp(Artist.NAME_PROPERTY, <span class="string">"Pablo Picasso"</span>);</span><br><span class="line">SelectQuery select = <span class="keyword">new</span> SelectQuery(Artist.class, qualifier);</span><br><span class="line">Artist picasso = (Artist) Cayenne.objectForQuery(context, select);</span><br></pre></td></tr></table></figure>
<p>现在, 让我们删除这个艺术家:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (picasso != <span class="keyword">null</span>) &#123;</span><br><span class="line">    context.deleteObject(picasso);</span><br><span class="line">    context.commitChanges();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>因为我们为 Artist.paintings 关系设置了 “Cascade” 删除约束, Cayenne会自动删除这个艺术家所有的画作.</p>
<p>因此, 当我们运行这个程序时, 你将会看到如下输出:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">INFO: SELECT t0.DATE_OF_BIRTH, t0.NAME, t0.ID FROM ARTIST t0</span><br><span class="line">      WHERE t0.NAME = ? [bind: 1-&gt;NAME:&apos;Pablo Picasso&apos;] - prepared in 6 ms.</span><br><span class="line">INFO: === returned 1 row. - took 18 ms.</span><br><span class="line">INFO: +++ transaction committed.</span><br><span class="line">INFO: --- transaction started.</span><br><span class="line">INFO: DELETE FROM PAINTING WHERE ID = ?</span><br><span class="line">INFO: [batch bind: 1-&gt;ID:200]</span><br><span class="line">INFO: [batch bind: 1-&gt;ID:201]</span><br><span class="line">INFO: === updated 2 rows.</span><br><span class="line">INFO: DELETE FROM ARTIST WHERE ID = ?</span><br><span class="line">INFO: [batch bind: 1-&gt;ID:200]</span><br><span class="line">INFO: === updated 1 row.</span><br><span class="line">INFO: +++ transaction committed.</span><br></pre></td></tr></table></figure></p>
<h1><a href="#4-zhuan-huan-wei-web-ying-yong-cheng-xu" class="header-anchor"></a><span id="4-zhuan-huan-wei-web-ying-yong-cheng-xu">4. 转换为Web应用程序</span></h1><p>本章将展示 Cayenne 如何在Web应用程序中工作</p>
<h2><a href="#4-1-jiang-tutorial-xiang-mu-zhuan-huan-wei-web-ying-yong-cheng-xu" class="header-anchor"></a><span id="4-1-jiang-tutorial-xiang-mu-zhuan-huan-wei-web-ying-yong-cheng-xu">4.1. 将 tutorial 项目转换为 Web应用程序</span></h2><p>Web应用程序教程的 Web 部分是在 JSP 中完成的, 而 JSP 是 Java Web 技术中最常见的实现方法.</p>
<p>本教程在 UI 方面尽可能地简单, 主要专注于 Cayenne 集成, 而不是界面.</p>
<p>一个典型的 Cayenne Web 应用程序像下面这样工作：</p>
<ul>
<li>在应用程序上下文启动时, 使用一个特定的 Servlet 过滤器加载 Cayenne 的配置</li>
<li>用户请求被过滤器拦截, 并将 DataContext 绑定到请求线程, 因此应用程序可以从任何地方轻松访问它.</li>
<li>同一个 DataContext 实例在单个用户会话 ( Session ) 中被重用; 不同的会话使用不同的 DataContexts ( 以及不同的对象集). 根据应用的具体情况, 上下文可以有不同的范围. 本教程中我们将使用会话范围的上下文 ( Context ).</li>
</ul>
<p>让我们将我们此前创建的 tutorial 项目转换为一个 Web 应用程序:</p>
<ul>
<li>在Eclipse中的 “tutorial” 项目下创建一个新的文件夹 “src/main/webapp/WEB-INF”.</li>
<li>在 <code>WEB-INF</code> 下创建一个新文件 <code>web.xml</code> ( 一个标准的Web应用程序描述文件 ):</li>
</ul>
<p><strong>web.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"> <span class="meta">&lt;!DOCTYPE web-app</span></span><br><span class="line"><span class="meta">   PUBLIC "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span><br><span class="line"><span class="meta">  "http://java.sun.com/dtd/web-app_2_3.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Cayenne Tutorial<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- This filter bootstraps ServerRuntime and then provides each request thread</span></span><br><span class="line"><span class="comment">         with a session-bound DataContext. Note that the name of the filter is important,</span></span><br><span class="line"><span class="comment">         as it points it to the right named configuration file.</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cayenne-project<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.cayenne.configuration.web.CayenneFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>cayenne-project<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>创建一个艺术家浏览页面 <code>src/main/webapp/index.jsp</code>, 包含如下内容:</li>
</ul>
<p><strong>webapp/index.jsp</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.example.cayenne.persistent.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.cayenne.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.cayenne.query.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.cayenne.exp.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    SelectQuery query = <span class="keyword">new</span> SelectQuery(Artist.class);</span><br><span class="line">    query.addOrdering(Artist.NAME_PROPERTY, SortOrder.ASCENDING);</span><br><span class="line"></span><br><span class="line">    ObjectContext context = BaseContext.getThreadObjectContext();</span><br><span class="line">    List&lt;Artist&gt; artists = context.performQuery(query);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Main&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h2&gt;Artists:&lt;/h2&gt;</span><br><span class="line"></span><br><span class="line">        &lt;% <span class="keyword">if</span>(artists.isEmpty()) &#123;%&gt;</span><br><span class="line">        &lt;p&gt;No artists found&lt;/p&gt;</span><br><span class="line">        &lt;% &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(Artist a : artists) &#123;</span><br><span class="line">        %&gt;</span><br><span class="line">        &lt;p&gt;&lt;a href="detail.jsp?id=&lt;%=Cayenne.intPKForObject(a)%&gt;"&gt; &lt;%=a.getName()%&gt; &lt;/a&gt;&lt;/p&gt;</span><br><span class="line">        &lt;%</span><br><span class="line">            &#125;</span><br><span class="line">            &#125; %&gt;</span><br><span class="line">        &lt;hr&gt;</span><br><span class="line">        &lt;p&gt;&lt;a href="detail.jsp"&gt;Create new artist...&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>创建一个艺术家编辑页面 <code>src/main/webapp/detail.jsp</code>, 包含如下内容:</li>
</ul>
<p><strong>webapp/detail.jsp</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.example.cayenne.persistent.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.apache.cayenne.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*"</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.text.*"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    ObjectContext context = BaseContext.getThreadObjectContext();</span><br><span class="line">    String id = request.getParameter(<span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find artist for id</span></span><br><span class="line">    Artist artist = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(id != <span class="keyword">null</span> &amp;&amp; id.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        artist = Cayenne.objectForPK(context, Artist.class, Integer.parseInt(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">"POST"</span>.equals(request.getMethod())) &#123;</span><br><span class="line">        <span class="comment">// if no id is saved in the hidden field, we are dealing with</span></span><br><span class="line">        <span class="comment">// create new artist request</span></span><br><span class="line">        <span class="keyword">if</span>(artist == <span class="keyword">null</span>) &#123;</span><br><span class="line">            artist = context.newObject(Artist.class);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// note that in a real application we would so dome validation ...</span></span><br><span class="line">        <span class="comment">// here we just hope the input is correct</span></span><br><span class="line">        artist.setName(request.getParameter(<span class="string">"name"</span>));</span><br><span class="line">        artist.setDateOfBirthString(request.getParameter(<span class="string">"dateOfBirth"</span>));</span><br><span class="line"></span><br><span class="line">        context.commitChanges();</span><br><span class="line"></span><br><span class="line">        response.sendRedirect(<span class="string">"index.jsp"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(artist == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// create transient artist for the form response rendering</span></span><br><span class="line">        artist = <span class="keyword">new</span> Artist();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String name = artist.getName() == <span class="keyword">null</span> ? <span class="string">""</span> : artist.getName();</span><br><span class="line">    String dob = artist.getDateOfBirth() == <span class="keyword">null</span></span><br><span class="line">            ? <span class="string">""</span> : <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyyMMdd"</span>).format(artist.getDateOfBirth());</span><br><span class="line">%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Artist Details&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;h2&gt;Artists Details&lt;/h2&gt;</span><br><span class="line">        &lt;form name=<span class="string">"EditArtist"</span> action=<span class="string">"detail.jsp"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">            &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"id"</span> value=<span class="string">"&lt;%= id != null ? id : "</span><span class="string">" %&gt;"</span> /&gt;</span><br><span class="line">            &lt;table border=<span class="string">"0"</span>&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;Name:&lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;&lt;input type="text" name="name" value="&lt;%= name %&gt;"/&gt;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;<span class="function">Date of <span class="title">Birth</span> <span class="params">(yyyyMMdd)</span>:&lt;/td&gt;</span></span><br><span class="line">                    &lt;td&gt;&lt;input type="text" name="dateOfBirth" value="&lt;%= dob %&gt;"/&gt;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;td&gt;&lt;/td&gt;</span><br><span class="line">                    &lt;td align="right"&gt;&lt;input type="submit" value="Save" /&gt;&lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/table&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h4><a href="#yun-xing-web-ying-yong-cheng-xu" class="header-anchor"></a><span id="yun-xing-web-ying-yong-cheng-xu"><strong>运行Web应用程序</strong></span></h4><p>为了运行这个Web应用程序, 我们将使用 “maven-jetty-plugin”.</p>
<blockquote>
<p><small>译注: jetty 是一个 Web 应用程序容器, 作用类似 Tomcat.</small></p>
</blockquote>
<p>为了激活它, 让我们添加如下的代码到 “pom.xml” 中, 跟在 “dependencies” 部分的后面, 保存POM.</p>
<p><strong>pom.xml</strong><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.eclipse.jetty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jetty-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.3.14.v20161028<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>打开 “Run &gt; Run Configurations…​” 菜单, 选择 “Maven Build”, 点击右键并选择 “New”</li>
<li>确定你填写了 “Name”, “Base directory” 和 “Goals”, 如下图:</li>
</ul>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/eclipse-mvnrun.png" alt=""></p>
<ul>
<li>依次点击 “Apply” 和 “Run”. </li>
</ul>
<p>首次运行时可能会花费几分钟下载Jetty插件所有的依赖,<br>  但是最终你将看到如下的日志:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[INFO] Scanning for projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building tutorial 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">...</span><br><span class="line">[INFO] Configuring Jetty for project: tutorial</span><br><span class="line">[INFO] Webapp source directory = /.../tutorial/src/main/webapp</span><br><span class="line">[INFO] Reload Mechanic: automatic</span><br><span class="line">[INFO] Classes = /.../tutorial/target/classes</span><br><span class="line">[INFO] Context path = /tutorial</span><br><span class="line">[INFO] Tmp directory =  determined at runtime</span><br><span class="line">[INFO] Web defaults = org/mortbay/jetty/webapp/webdefault.xml</span><br><span class="line">[INFO] Web overrides =  none</span><br><span class="line">[INFO] web.xml file = /.../tutorial/src/main/webapp/WEB-INF/web.xml</span><br><span class="line">[INFO] Webapp directory = /.../tutorial/src/main/webapp</span><br><span class="line">[INFO] Starting jetty 6.1.22 ...</span><br><span class="line">INFO::jetty-6.1.22</span><br><span class="line">INFO::No Transaction manager found - if your webapp requires one, please configure one.</span><br><span class="line">INFO::Started SelectChannelConnector@0.0.0.0:8080</span><br><span class="line">[INFO] Started Jetty Server</span><br></pre></td></tr></table></figure></p>
<ul>
<li>至此, Jetty 容器已经启动了.</li>
<li><p>现在, 在浏览器中打开网址  <a href="http://localhost:8080/tutorial/" target="_blank" rel="noopener">http://localhost:8080/tutorial/</a>.</p>
<p>你应该在浏览器中看到 “No artists found message”, 同时在 Eclipse 的控制台中可看到如下输出:</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">INFO: Loading XML configuration resource from file:/.../tutorial/target/classes/cayenne-project.xml</span><br><span class="line">INFO: loading user name and password.</span><br><span class="line">INFO: Created connection pool: jdbc:derby:memory:testdb;create=true</span><br><span class="line">    Driver class: org.apache.derby.jdbc.EmbeddedDriver</span><br><span class="line">    Min. connections in the pool: 1</span><br><span class="line">    Max. connections in the pool: 1</span><br><span class="line">INFO: Opening connection: jdbc:derby:memory:testdb;create=true</span><br><span class="line">    Login: null</span><br><span class="line">    Password: *******</span><br><span class="line">INFO: +++ Connecting: SUCCESS.</span><br><span class="line">INFO: Detected and installed adapter: org.apache.cayenne.dba.derby.DerbyAdapter</span><br><span class="line">INFO: --- transaction started.</span><br><span class="line">INFO: No schema detected, will create mapped tables</span><br><span class="line">INFO: CREATE TABLE GALLERY (ID INTEGER NOT NULL, NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: CREATE TABLE ARTIST (DATE_OF_BIRTH DATE, ID INTEGER NOT NULL, NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: CREATE TABLE PAINTING (ARTIST_ID INTEGER, GALLERY_ID INTEGER, ID INTEGER NOT NULL,</span><br><span class="line">      NAME VARCHAR (200), PRIMARY KEY (ID))</span><br><span class="line">INFO: ALTER TABLE PAINTING ADD FOREIGN KEY (ARTIST_ID) REFERENCES ARTIST (ID)</span><br><span class="line">INFO: ALTER TABLE PAINTING ADD FOREIGN KEY (GALLERY_ID) REFERENCES GALLERY (ID)</span><br><span class="line">INFO: CREATE TABLE AUTO_PK_SUPPORT (</span><br><span class="line">      TABLE_NAME CHAR(100) NOT NULL,  NEXT_ID BIGINT NOT NULL,  PRIMARY KEY(TABLE_NAME))</span><br><span class="line">INFO: DELETE FROM AUTO_PK_SUPPORT WHERE TABLE_NAME IN (&apos;ARTIST&apos;, &apos;GALLERY&apos;, &apos;PAINTING&apos;)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;ARTIST&apos;, 200)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;GALLERY&apos;, 200)</span><br><span class="line">INFO: INSERT INTO AUTO_PK_SUPPORT (TABLE_NAME, NEXT_ID) VALUES (&apos;PAINTING&apos;, 200)</span><br><span class="line">INFO: SELECT t0.DATE_OF_BIRTH, t0.NAME, t0.ID FROM ARTIST t0 ORDER BY t0.NAME - prepared in 43 ms.</span><br><span class="line">INFO: === returned 0 rows. - took 56 ms.</span><br><span class="line">INFO: +++ transaction committed.</span><br></pre></td></tr></table></figure>
<ul>
<li>你可以点击 “Create new artist” 链接去新建艺术家. 对于已存在的艺术家的可以通过点击他的名字来进行编辑.</li>
</ul>
<p><img src="https://cayenne.apache.org/docs/3.1/getting-started-guide/images/firefox-webapp.png" alt=""></p>
<p>你已完成了本教程!</p>
<blockquote>
<p>注: 目前 Apache 已发布了 Cayenne 的 4.0 版本, 相对而言 4.0 版本更好用些, 当然使用方法上也有些变化. </p>
<p>请参阅:  <a href="/2019/05/11/Cayenne入门指南4-0/">Cayenne 起步 (Version 4.0)</a>.</p>
</blockquote>

        </div>
        <p class="post-revise-info">
            Revised on <span class="date">2019/05/12 01:10:44</span> by 阿卜
        </p>
        
        <!-- 上一篇/下一篇  -->
        <hr/>
        <ul class="post-paginator">
            <li class="next">
                
                    <div class="nextSlogan">Next Post</div>
                    <a href= "/2018/04/21/持久层框架Cayenne推介/" title= "持久层框架 Cayenne 推介">
                        持久层框架 Cayenne 推介
                    </a>
                
            </li>
            <li class="previous">
                
                    <div class="prevSlogan">Previous Post</div>
                    <a href= "/2016/08/11/面向对象起步-封装-继承-多态/" title= "面向对象起步 --- 封装、继承、多态">
                        面向对象起步 --- 封装、继承、多态
                    </a>
                
            </li>
        </ul>
      </div>
    </div>
  </div>
</article>

<script>
  var toc = document.querySelector(".toc");
  // 若有侧边目录, 则设置目录效果
  if (toc) {
    toc.onmouseover = function(){
      toc.classList.remove("toc-shrink");
    };
    toc.onmouseout = function(){
      toc.classList.add("toc-shrink");
    };

    // 延迟 5 秒后自动隐藏
    window.setTimeout(function(){
      toc.classList.add("toc-shrink");
    }, 5000);

    // 目录跟随滚动效果
    var setTocPosition = function() {
      //变量t是滚动条滚动时，距离顶部的距离
      var t = document.documentElement.scrollTop||document.body.scrollTop;
    
      //当滚动到距离顶部200px时，返回顶部的锚点显示
      if(t < 300){
        toc.style.top = (300 - t) + 'px';
      } else{          //恢复正常
        toc.style.top = "20px";
      }
    }

    window.onscroll = function(){
        setTocPosition();
    }
    setTocPosition();
  }
</script>


    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a> 
        <p class="copyright text-muted">
          Copyright By <a href="mailto:baileiz@163.com">阿卜.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<!-- <script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script> -->

  </body>
</html>

